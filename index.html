<html>
  <head>
    <meta charset="utf-8"/>
    <title>iOS Web Audio Performance Issue</title>
    <script src="https://cdn.jsdelivr.net/npm/resonance-audio/build/resonance-audio.min.js"></script>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script type="text/javascript">
      AFRAME.registerComponent("myscene", {
        init() {
          this.resonanceSources = [];
          this.audioContext = new window.AudioContext();
          const resonanceAudio = new ResonanceAudio(this.audioContext, { ambisonicOrder: 5 });
          resonanceAudio.output.connect(this.audioContext.destination);

          this.resonanceSources.push(resonanceAudio.createSource());
          const audioEl0 = document.querySelector("#audio0");
          const audioSource0 = this.audioContext.createMediaElementSource(audioEl0);
          audioElSource0.connect(this.resonanceSources[0].input);
          
          this.resonanceSources.push(resonanceAudio.createSource());
          const audioEl1 = document.querySelector("#audio1");
          const audioSource1 = this.audioContext.createMediaElementSource(audioEl1);
          audioElSource1.connect(this.resonanceSources[1].input);
          
          this.resonanceSources.push(resonanceAudio.createSource());
          const audioEl2 = document.querySelector("#audio2");
          const audioSource2 = this.audioContext.createMediaElementSource(audioEl2);
          audioElSource2.connect(this.resonanceSources[2].input);
          
          this.resonanceSources.push(resonanceAudio.createSource());
          const audioEl3 = document.querySelector("#audio3");
          const audioSource3 = this.audioContext.createMediaElementSource(audioEl3);
          audioElSource3.connect(this.resonanceSources[3].input);
        }
      });

      AFRAME.registerComponent("source", {
        //source index
        schema: { type: "int" },
        init() {
          this.el.sceneEl.addEventListener("loaded", this.postSceneLoad.bind(this));
        },
        postSceneLoad() {
          this.resonanceSource = this.el.sceneEl.components["myscene"].resonanceSources[this.data];
          this.el.object3D.getWorldPosition(this.globalPosition);
          this.resonanceSource.setPosition(this.globalPosition.x, this.globalPosition.y, this.globalPosition.z);
        },
      });
    </script>
  </head>
  <body>
    <audio id="audio0" src="music.mp4" preload="auto"></audio>
    <audio id="audio1" src="music.mp4" preload="auto"></audio>
    <audio id="audio2" src="music.mp4" preload="auto"></audio>
    <audio id="audio3" src="music.mp4" preload="auto"></audio>
    <a-scene myscene embedded>
      <a-box source="0" position="-4 0 0"></a-box>
      <a-box source="1" position="4 0 0"></a-box>
      <a-box source="2" position="0 0 -4"></a-box>
      <a-box source="3" position="0 0 4"></a-box>
    </a-scene>
    <div style="width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 9999;">
      <button id="my-button" disabled>Loading...</button>
    </div>

    <script type="text/javascript">
      window.addEventListener("load", () => {
        //play button
        document.querySelector("#my-button").addEventListener("click", () => {
          document.querySelectorAll("audio").forEach((audioEl, index) => {
            document.querySelector("[myscene]").components["myscene"].audioContext.resume();
            setTimeout(audioEl.play(), index * 1000);
          })
        })

        //switch to play when loaded
        document.querySelectorAll("audio").forEach((audioEl) => {
          //iOS seems to need small timeout to load
          setTimeout(() => audioEl.load(), 50);
          let numLoaded = 0;
          audioEl.addEventListener("canplaythrough", () => {
            numLoaded += 1;
            if (numLoaded >= 4) {
              document.querySelector("#my-button").disabled = false;
            }
          })
        })
      });

    </script>
  </body>
</html>